$INCLUDE	(REG_MPC82G516.inc)
	ORG	00H                   
	JMP	START
	ORG	03H
	JMP	STOPALA
	ORG	13H
	JMP	WARN
	ORG	2BH
	JMP	TIMER2 
	ORG	0BH
	JMP	DELAY60MS 
	ORG	4BH
	JMP	IADC                 
	ORG	50H                   
START:
	MOV	R0,#0
	MOV	R1,#0
	MOV	R2,#0
	MOV	R3,#0
	MOV	R4,#0
	MOV	R5,#0
	MOV	R6,#5
	MOV	25H,#0
	MOV	27H,#0
	MOV	28H,#0
	MOV	29H,#0
	MOV	30H,#0
	MOV	31H,#0
	MOV	32H,#0
	MOV	33H,#0
	MOV	34H,#0
	MOV	35H,#0
	MOV	24H,#5
	CLR	P3.0
	CLR	P3.7
	SETB	IT0
	CLR	IT1
	MOV	IE,#10101011B
	MOV	IP,#00101011B 
BEGIN:
	CALL	CHECKWA
	CALL	ROW1
	CALL	TRY
	MOV	A,25H
	CJNE	A,#2,BEGIN
	MOV	A,R5
	CJNE	A,30H,BEGIN
	MOV	A,R4
	CJNE	A,29H,BEGIN
	MOV	A,R3
	CJNE	A,28H,BEGIN
	MOV	A,R2
	CJNE	A,27H,BEGIN
	CALL	ALARM
	JMP	BEGIN
DELAY60MS:
	CLR	TF0
	CPL	P3.7
	MOV	TH0,#21
	MOV	TL0,#160
	MOV	33H,R7
	MOV	R7,TH1
	CJNE	R7,#1,BACKDELAY
	MOV	R7,TL1
	CJNE	R7,#245,BACKDELAY
	MOV	TL1,#0
	MOV	TH1,#0
	MOV	R7,33H	
	CALL	MIN	
BACKDELAY:
	RETI
MIN:
	INC	R5
	CJNE	R5,#10,GOBACK
	MOV	R5,#0
	INC	R4
	CJNE	R4,#6,GOBACK
	MOV	R4,#0
	INC	R3
	CJNE	R2,#2,HOUR
	CJNE	R3,#4,GOBACK
	MOV	R3,#0
	MOV	R2,#0
	JMP	GOBACK
HOUR:
	CJNE	R3,#10,GOBACK
	MOV	R3,#0
	INC	R2
GOBACK:
	RET
ROW1:
	MOV	P2,#01111111B           
	CALL	DELAY                
	MOV	A,P2                     
	ANL	A,#0FH                   
	MOV	R1,#0                   
	CJNE	A,#0FH,COL1                             
ROW2:
	MOV	P2,#10111111B            
	CALL	DELAY                 
	MOV	A,P2                    
	ANL	A,#0FH              
	MOV	R1,#4                
	CJNE	A,#0FH,COL1  
ROW3:
	MOV	P2,#11011111B        
	CALL	DELAY               
	MOV	A,P2                 
	ANL	A,#0FH               
	MOV	R1,#8                
	CJNE	A,#0FH,COL1                         
ROW4:
	MOV	P2,#11101111B        
	CALL	DELAY 
	MOV	A,P2                          
	ANL	A,#0FH                   
	MOV	R1,#12                   
	CJNE	A,#0FH,CO1                           
	JMP	BACKSHOW                  
COL1:
	CJNE	A,#0EH,COL2
	MOV	R0,#0 
	JMP	GOSHOW                       
COL2:
	CJNE	A,#0DH,COL3 
	MOV	R0,#1                  
	JMP	GOSHOW                        
COL3:
	CJNE	A,#0BH,COL4      
	CJNE	R1,#8,CO3
	CALL	SETTIME
	JMP	BACKSHOW
COL4:
	CJNE	A,#07H,BACKSHOW       
	CJNE	R1,#8,CO4
	CALL	STARTCLK
	JMP	BACKSHOW
CO1:
	CJNE	A,#0EH,CO1_1
	CALL	SETALA	
	JMP	BACKSHOW
CO1_1:
	CJNE	A,#0DH,CO1_2
	CALL	STARTALA	                 
	JMP	BACKSHOW
CO1_2:
	CJNE	A,#0BH,CO1_3
	MOV	A,24H
	CJNE	A,25H,CO1_2_1
	JMP	BACKSHOW
CO1_2_1:
	MOV	24H,25H
	MOV	25H,#3
	CALL	DELAYB
	CALL	INIADC	
	JMP	BACKSHOW
CO1_3:
	CJNE	A,#07H,BACKSHOW
	MOV	25H,24H
	CALL	DELAYB	
	JMP	BACKSHOW
CO3:
	MOV	R0,#2                   
	JMP	GOSHOW                 
CO4:
	MOV	R0,#3
	JMP	GOSHOW
GOSHOW:
	CJNE	R6,#0,GOSHOW1
	JMP	BACKSHOW
GOSHOW1:
	MOV	R7,25H
	CJNE	R7,#1,GOSHOW2
	CALL	SH
	JMP	BACKSHOW
GOSHOW2:
	CJNE	R7,#3,GOSHOW3
	JMP	BACKSHOW
GOSHOW3:
	CALL	SHOW
BACKSHOW:
	RET
SHOW:	
	CJNE	R6,#4,SHOW1       
	MOV	A,R1
	ADD	A,R0
	CJNE	A,#0,SHOW_1
	MOV	R2,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK                   
SHOW_1:
	CJNE	A,#1,SHOW_2
	MOV	R2,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK 
SHOW_2:
	CJNE	A,#2,BACKBACK
	MOV	R2,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW1:
	CJNE	R6,#3,SHOW2      
	MOV	A,R1
	ADD	A,R0
	CJNE	R2,#2,SHOW1_1_1
	CJNE	A,#0,SHOW1_1
	MOV	R3,A
	DEC	R6 
	CALL	DELAYB
	JMP	BACK
SHOW1_1:
	CJNE	A,#1,SHOW1_2
	MOV	R3,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK                  
SHOW1_2:
	CJNE	A,#2,SHOW1_3
	MOV	R3,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW1_3:
	CJNE	A,#3,BACKBACK
	MOV	R3,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
BACKBACK:
	JMP	BACK
SHOW1_1_1:
	MOV	R3,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW2:
	CJNE	R6,#2,SHOW3     
	MOV	A,R1
	ADD	A,R0
	CJNE	A,#0,SHOW2_1
	MOV	R4,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW2_1:
	CJNE	A,#1,SHOW2_2
	MOV	R4,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW2_2:
	CJNE	A,#2,SHOW2_3
	MOV	R4,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW2_3:
	CJNE	A,#3,SHOW2_4
	MOV	R4,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW2_4:
	CJNE	A,#4,SHOW2_5
	MOV	R4,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW2_5:
	CJNE	A,#5,BACK
	MOV	R4,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
SHOW3:
	CJNE	R6,#1,BACK
	MOV	A,R1
	ADD	A,R0
	MOV	R5,A
	DEC	R6
	CALL	DELAYB
	JMP	BACK
BACK:
	RET
SH:	
	CJNE	R6,#4,SH1       
	MOV	A,R1
	ADD	A,R0
	CJNE	A,#0,SH_1
	MOV	27H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA                  
SH_1:
	CJNE	A,#1,SH_2
	MOV	27H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA 
SH_2:
	CJNE	A,#2,BABA
	MOV	27H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
SH1:
	CJNE	R6,#3,SH2      
	MOV	A,R1
	ADD	A,R0
	MOV	R7,27H
	CJNE	R7,#2,SH1_1_1
	CJNE	A,#0,SH1_1
	MOV	28H,A
	DEC	R6 
	CALL	DELAYB
	JMP	BA
SH1_1:
	CJNE	A,#1,SH1_2
	MOV	28H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA                  
SH1_2:
	CJNE	A,#2,SH1_3
	MOV	28H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
SH1_3:
	CJNE	A,#3,BABA
	MOV	28H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
BABA:
	JMP	BA
SH1_1_1:
	MOV	28H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
SH2:
	CJNE	R6,#2,SH3     
	MOV	A,R1
	ADD	A,R0
	CJNE	A,#0,SH2_1
	MOV	29H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
SH2_1:
	CJNE	A,#1,SH2_2
	MOV	29H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
SH2_2:
	CJNE	A,#2,SH2_3
	MOV	29H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
SH2_3:
	CJNE	A,#3,SH2_4
	MOV	29H,A
	DEC R6
	CALL	DELAYB
	JMP	BA
SH2_4:
	CJNE	A,#4,SH2_5
	MOV	29H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
SH2_5:
	CJNE	A,#5,BA
	MOV	29H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
SH3:
	CJNE	R6,#1,BA
	MOV	A,R1
	ADD	A,R0
	MOV	30H,A
	DEC	R6
	CALL	DELAYB
	JMP	BA
BA:
	RET
TRY:
	MOV	36H,A
	MOV	R7,25H
	CJNE	R7,#1,TRY1
	MOV	A,30H
	ADD	A,#01110000B
	MOV	P0,A             
	CALL	DELAY
	MOV	A,29H
	ADD	A,#10110000B
	MOV	P0,A                   
	CALL	DELAY
	MOV	A,28H
	ADD	A,#11010000B
	MOV	P0,A                   
	CALL	DELAY
	MOV	A,27H
	ADD	A,#11100000B
	MOV	P0,A                   
	CALL	DELAY
	JMP	BACKTRY
TRY1:
	CJNE	R7,#3,TRY2
	MOV	R6,#255
TRY1_1:
	MOV	A,35H
	ADD	A,#01110000B
	MOV	P0,A                   
	CALL	DELAY
	MOV	A,34H
	ADD	A,#10110000B
	MOV	P0,A                   
	CALL	DELAY
	MOV	A,32H
	ADD	A,#11010000B
	MOV	P0,A                   
	CALL	DELAY
	MOV	A,31H
	ADD	A,#11100000B
	MOV	P0,A                   
	CALL	DELAY
	DJNZ	R6,TRY1_1
	MOV	R6,#0
	JMP	BACKTRY
TRY2: 
	MOV	A,#01110000B
	ADD	A,R5
	MOV	P0,A                   
	CALL	DELAY
	MOV	A,#10110000B
	ADD	A,R4
	MOV	P0,A                   
	CALL	DELAY
	MOV	A,#11010000B
	ADD	A,R3
	MOV	P0,A                   
	CALL	DELAY
	MOV	A,#11100000B
	ADD	A,R2
	MOV	P0,A                   
	CALL	DELAY
BACKTRY:
	MOV	A,36H
	RET
SETTIME:
	CLR	TR0
	CLR	TF0
	CLR	P3.7        //TO P3.4 
	MOV	TL1,#0
	MOV	TH1,#0
	MOV	R6,#4
	RET
STARTCLK:
	MOV	TMOD,#01010001B          ;SETB	IT0    ;MOV	T2CON,#00000000B   ;MOV	RCAP2H,#21    ;MOV	RCAP2L,#160
	MOV	TH0,#21
	MOV	TL0,#160
	MOV	R6,#0
	CLR	TF1
	CLR	TF0	
	SETB	TR0
	SETB	TR1
	RET
DELAY:
	MOV	R7,#250               
DELAY2:
	DJNZ	R7,DELAY2             
	RET
DELAYB:
	MOV	R1,#200
DELAYB1:
	MOV	R0,#100
DELAYB2:
	MOV	R7,#40
DELAYB3:
	DJNZ	R7,DELAYB3		
	DJNZ	R0,DELAYB2		//CAN'T CHANGE WHEN USING TIMER0	  
	DJNZ	R1,DELAYB1		//SAME AS ABOVE    POP & PUSH??		   
	RET
CHECKWA:
	JB	90H,CHECKWA1
	MOV	IE,#10101111B
	MOV	IP,#00101111B
	JMP	BACKCHE
CHECKWA1:
	MOV	IE,#10101011B
	MOV	IP,#00101011B
BACKCHE:
	RET	
SETALA:
	MOV	25H,#1
	MOV	R6,#4
	RET
STARTALA:
	MOV	25H,#2
	MOV	R6,#0
	RET
ALARM:
	MOV	DPTR,#SCALE
	MOV	T2CON,#00000000B
	MOV	R6,#1
	MOV	R1,#3
	MOV	R0,#110
	SETB	IT0
	MOV	TH2,#11110111B
	MOV	TL2,#00011111B
	MOV	RCAP2H,#11110111B
	MOV	RCAP2L,#00011111B
	CLR	TF2	
	SETB	TR2
LOOPALA:
	CALL	TRY
	CJNE	R6,#0,LOOPALA
LOOPALA1:
	CALL	TRY
	MOV	A,R5
	CJNE	A,30H,BAALA
	JMP	LOOPALA1
BAALA:
	RET
TIMER2:
	CLR	TF2
	CPL	P3.6
	DJNZ	R0,BACKALA
	MOV	A,R1
	MOVC	A,@A+DPTR
	MOV	TH2,A
	MOV	RCAP2H,A
	INC	R1
	MOV	A,R1
	MOVC	A,@A+DPTR
	MOV	TL2,A
	MOV	RCAP2L,A
	INC	R1
	MOV	A,R1
	MOVC	A,@A+DPTR
	MOV	R0,A
	INC	R1
	CJNE	R1,#33,BACKALA
	MOV	R1,#0
BACKALA:
	RETI
STOPALA:
	CLR	TR2
	CLR	TF2
	CLR	P3.6
	MOV	R6,#0
	MOV	25H,#0
	RETI
INIADC:
	MOV	ADCTL,#0E2H ;ADCON=1, turn on ADC hardware  ;(SPEED1,SPEED0)=(1,1), Conv. Time= 270 clock cycles  ;select AIN0 (P1.2) as analog input
	ORL	P1M0,#00000100B ;P1M0,bit2=1 ;configure P1.2 as Input-Only Mode
	ANL	P1M1,#11111011B ;P1M1,bit2=0 ;
	ORL	AUXR,#01000000B ;ADRJ=0: ADCH contains B9~B2; ADCL contains B1,B0  ;now, suppose the analog input is ready on AIN2 (P1.2)
	ORL	AUXIE,#00000010B
	ANL	ADCTL,#11101111B
	ORL	ADCTL,#00001000B
	CALL	DELAY
LOOPADC:
	MOV	R7,25H
	CJNE	R7,#3,BAADC
	CALL CHECKWA
	MOV	22H,A
	MOV	A,ADCTL
	ANL	A,#00010000B
	CJNE	A,#00000000B,LOOPADC
	ORL	ADCTL,#00001000B
	CALL	DELAY
	JMP	LOOPADC
BAADC:
	ANL	ADCTL,#11100111B
	MOV	24H,#5
	MOV	A,22H
	RET
IADC:	
	ANL	ADCTL,#11100111B
	CALL	ROW1
	CALL	TRY
	CALL CHECKWA
	MOV	A,ADCL
	MOV	B,#100
	DIV	AB
	MOV	32H,A
	MOV	A,B
	MOV	B,#10
	DIV	AB
	MOV	34H,A
	MOV	A,B
	MOV	35H,A
	MOV	A,ADCH
ADC0:
	CJNE	A,#0,ADC1
	MOV	31H,#0
	JMP	BACKADC
ADC1:
	CJNE	A,#1,ADC2
	MOV	A,35H
	CJNE	A,#0,ADC1_1
	ADD	A,#6
	MOV	35H,A
	JMP	ADC1_1_0
ADC1_1:
	CJNE	A,#1,ADC1_2
	ADD	A,#6
	MOV	35H,A
	JMP	ADC1_1_0
ADC1_2:
	CJNE	A,#2,ADC1_3
	ADD	A,#6
	MOV	35H,A
	JMP	ADC1_1_0
ADC1_3:
	CJNE	A,#3,ADC1_4
	ADD	A,#6
	MOV	35H,A
	JMP	ADC1_1_0
ADC1_4:
	ADD	A,#6
	SUBB	A,#10
	MOV	35H,A
	MOV	A,34H
	ADD	A,#1
	MOV	34H,A
ADC1_1_0:
	MOV	A,34H
	CJNE	A,#0,ADC1_1_1
	ADD	A,#5
	MOV	34H,A
	JMP	ADC1_B
ADC1_1_1:
	CJNE	A,#1,ADC1_1_2
	ADD	A,#5
	MOV	34H,A
	JMP	ADC1_B
ADC1_1_2:
	CJNE	A,#2,ADC1_1_3
	ADD	A,#5
	MOV	34H,A
	JMP	ADC1_B
ADC1_1_3:
	CJNE	A,#3,ADC1_1_4
	ADD	A,#5
	MOV	34H,A
	JMP	ADC1_B
ADC1_1_4:
	CJNE	A,#4,ADC1_1_5
	ADD	A,#5
	MOV	34H,A
	JMP	ADC1_B
ADC1_1_5:
	ADD	A,#5
	SUBB	A,#10
	MOV	34H,A
	MOV	A,32H
	ADD	A,#1
	MOV	32H,A
ADC1_B:
	MOV	A,32H
	ADD	A,#2
	MOV	32H,A
	MOV	31H,#0
	JMP	BACKADC	
ADC2:
	CJNE	A,#2,ADC3
	MOV	A,35H
	CJNE	A,#8,ADC2_1
	ADD	A,#2
	SUBB	A,#10
	MOV	35H,A
	MOV	A,34H
	ADD	A,#1
	MOV	34H,A
	JMP	ADC2_1_0
ADC2_1:
	CJNE	A,#9,ADC2_2
	ADD	A,#2
	SUBB	A,#10
	MOV	35H,A
	MOV	A,34H
	ADD	A,#1
	MOV	34H,A
	JMP	ADC2_1_0
ADC2_2:
	ADD	A,#2
	MOV	35H,A
ADC2_1_0:
	MOV	A,34H
	CJNE	A,#9,ADC2_1_1
	ADD	A,#1
	SUBB	A,#10
	MOV	34H,A
	MOV	A,32H
	ADD	A,#1
	MOV	32H,A
	JMP	ADC2_B
ADC2_1_1:
	CJNE	A,#10,ADC2_1_2
	ADD	A,#1
	SUBB	A,#10
	MOV	34H,A
	MOV	A,32H
	ADD	A,#1
	MOV	32H,A
	JMP	ADC2_B
ADC2_1_2:
	ADD	A,#1
	MOV	34H,A
ADC2_B:
	MOV	A,32H
	ADD	A,#5
	MOV	32H,A
	MOV	31H,#0
	JMP	BACKADC		
ADC3:
	CJNE	A,#3,GOBAADC
	MOV	A,35H
	CJNE	A,#0,ADC3_1
	ADD	A,#8
	MOV	35H,A
	JMP	ADC3_1_0
ADC3_1:
	CJNE	A,#1,ADC3_2
	ADD	A,#8
	MOV	35H,A
	JMP	ADC3_1_0
ADC3_2:
	ADD	A,#8
	SUBB	A,#10
	MOV	35H,A
	MOV	A,34H
	ADD	A,#1
	MOV	34H,A
ADC3_1_0:
	MOV	A,34H
	CJNE	A,#0,ADC3_1_1
	ADD	A,#6
	MOV	34H,A
	JMP	ADC3_2_0
ADC3_1_1:
	CJNE	A,#1,ADC3_1_2
	ADD	A,#6
	MOV	34H,A
	JMP	ADC3_2_0
ADC3_1_2:
	CJNE	A,#2,ADC3_1_3
	ADD	A,#6
	MOV	34H,A
	JMP	ADC3_2_0
ADC3_1_3:
	CJNE	A,#3,ADC3_1_4
	ADD	A,#6
	MOV	34H,A
	JMP	ADC3_2_0
GOBAADC:
	JMP	BACKADC
ADC3_1_4:
	ADD	A,#6
	SUBB	A,#10
	MOV	34H,A
	MOV	A,32H
	ADD	A,#1
	MOV	32H,A
ADC3_2_0:
	MOV	A,32H
	CJNE	A,#0,ADC3_2_1
	ADD	A,#7
	MOV	32H,A
	MOV	31H,#0
	JMP	BACKADC
ADC3_2_1:
	CJNE	A,#1,ADC3_2_2
	ADD	A,#7
	MOV	32H,A
	MOV	31H,#0
	JMP	BACKADC
ADC3_2_2:
	CJNE	A,#2,ADC3_2_3
	ADD	A,#7
	MOV	32H,A
	MOV	31H,#0
	JMP	BACKADC
ADC3_2_3:
	ADD	A,#7
	SUBB	A,#10
	MOV	32H,A
	MOV	31H,#1	
BACKADC:
	CALL	TRY
	RETI
WARN:
	MOV	R1,#90
WARN1:
	MOV	R0,#2
WARN2:
	SETB	P3.6
	CALL	DELAY
	CLR	P3.6
	CALL	DELAY
	DJNZ	R0,WARN2
	DJNZ	R1,WARN1
	CALL	TRY
	RETI
SCALE:
	DB	11110111B,00011111B,110	
	DB	11110100B,11001110B,87
	DB	11110001B,00010111B,65
	DB	11110100B,11001110B,87
	DB	11110110B,00001000B,98
	DB	11111000B,10001000B,250
	DB	11110110B,00001000B,98
	DB	11110111B,00011111B,110
	DB	11110110B,00001000B,98
	DB	11110001B,00010111B,65
	DB	11110100B,11001110B,175
END
